<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="application-name" content="TiddlyWiki Plugin Library" />
<meta name="application-version" content="v0.0.0" />
<meta name="copyright" content="Copyright 2015 Jeremy Ruston" />
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<title>Plugin Library</title>
<script>
var assetList = [
    {
        "title": "$:/plugins/linonetwo/watch-fs",
        "description": "Reload changed tiddlers from disc filesystem",
        "author": "LinOnetwo",
        "core-version": ">=5.1.22",
        "plugin-type": "plugin",
        "version": "0.1.0",
        "dependents": "$:/plugins/twcloud/tiddlyweb-sse",
        "list": "readme",
        "type": "application/json",
        "Modern.TiddlyDev#SHA256-Hashed": "4f02e94342ec9430773362c967da31d581f8e059d56fcb2949df5f925b898028",
        "readme": "!! About\n\nThis plugin enables TiddlyWiki to watch the change in your disk, and if you edit one of your tiddler using text editor likes VSCode / Typora and save it on the disk, the change will immediately reflected in the browser / TidGi Desktop.\n\nSee [[https://github.com/Jermolene/TiddlyWiki5/issues/3060]] for related discussions.\n\n!! [[FileSystemMonitor.js|$:/plugins/linonetwo/watch-fs/FileSystemMonitor.js]]\n\nThis module watches the file system in the tiddlers folder and any changes to\nthe files in the folder that don't come from the browser are reported to the\nbrowser. So if you make a new .tid file in the tiddlers folder it will appear\nin the wiki in the browser without needing to restart the server. You can also\ndelete files to remove the tiddlers from the browser.\n\n!! Installation\n\nSome of the files are generated, but all the files are generated and ready to use in the `watch-fs` folder.\n\n!! Usage\n\nThis plugin will cause trouble if you build wiki with it enabled,\nso you have to remove it from your `tiddlywiki.info`, and add it to your wiki start arguments:\n\n```shell\ntiddlywiki +plugins/tiddlywiki/filesystem +plugins/tiddlywiki/tiddlyweb +plugins/linonetwo/watch-fs <path-to-wiki-folder> --listen\n```\n\n(why `+plugins/tiddlywiki/filesystem +plugins/tiddlywiki/tiddlyweb` here? See [[https://github.com/Jermolene/TiddlyWiki5/issues/4484#issuecomment-613200370]] for details)\n\n!!! Liminitation\n\n# can't handle rename in the disk, you can only rename from within the wiki (no such API to tell tw I've renamed a file)\n# I haven't tested this with [[$:/config/FileSystemPaths]] and [[Fix file info PR|https://github.com/Jermolene/TiddlyWiki5/pull/4630]] , but I use this feature every day, so I will definitely support it.\n# Can't handle if git change the tiddler while you are open its Draft tiddler (might be fixed by [[Deleting a draft tiddler should not also delete the original tiddler|https://github.com/Jermolene/TiddlyWiki5/issues/4792]] )\n\n!!! Using on network share / NFS\n\nIf the files are mounted from a remote, you will most likely use polling instead of the OS-native watcher.\nThis is not done automaticly, since there is really no way for us to detect that.\n\nIf your files are on a remote, you should set the environment-variable `CHOKIDAR_USEPOLLING=1`.\nYou can also configure the polling interval (default 100ms) using `CHOKIDAR_INTERVAL`.\n\n!! Implementation Details\n\n!!! How to decide whether a change is comes from the browser?\n\nWe will compare disk file and wiki file, if there is any discrepancy,\nthen we know the change is not made from the wiki, it is made by git or VSCode, in this case we read data from the disc,\nand add data to the tiddlywiki.\n\n!!! How to sync changes to the browser?\n\nwe can't trigger sync from the server, so we have to set a smaller sync interval in the client side.\n\nSo this plugin ship with a large [[$:/config/SyncPollingInterval]] to disable the build-in sync,\nand we add a new route `/linonetwo/watch-fs-can-sync` to the simple server, it will return `true` or `false`,\nand browser will poll this route, to see if it needs to trigger a `$tw.syncer.syncFromServer()`.\n",
        "requires-reload": "yes"
    }
];

/*\
title: $:/plugins/tiddlywiki/pluginlibrary/libraryserver.js
type: application/javascript
module-type: library

A simple HTTP-over-window.postMessage implementation of a standard TiddlyWeb-compatible server. It uses real HTTP to load the individual tiddler JSON files.

\*/
(function(){

/*jslint node: true, browser: true */
/*global $tw: false */
"use strict";

// Listen for window messages
window.addEventListener("message",function listener(event){
	console.log("plugin library: Received message from",event.origin);
	console.log("plugin library: Message content",event.data);
	switch(event.data.verb) {
		case "GET":
			if(event.data.url === "recipes/library/tiddlers.json") {
				// Route for recipes/library/tiddlers.json
				event.source.postMessage({
					verb: "GET-RESPONSE",
					status: "200",
					cookies: event.data.cookies,
					url: event.data.url,
					type: "application/json",
					body: JSON.stringify(assetList,null,4)
				},"*");
			} else if(event.data.url.indexOf("recipes/library/tiddlers/") === 0) {
				var url = "recipes/library/tiddlers/" + encodeURIComponent(removePrefix(event.data.url,"recipes/library/tiddlers/"));
				// Route for recipes/library/tiddlers/<uri-encoded-tiddler-title>.json
				httpGet(url,function(err,responseText) {
					if(err) {
						event.source.postMessage({
							verb: "GET-RESPONSE",
							status: "404",
							cookies: event.data.cookies,
							url: event.data.url,
							type: "text/plain",
							body: "Not found"
						},"*");
					} else {
						event.source.postMessage({
							verb: "GET-RESPONSE",
							status: "200",
							cookies: event.data.cookies,
							url: event.data.url,
							type: "application/json",
							body: responseText
						},"*");
					}
				});
			} else {
				event.source.postMessage({
					verb: "GET-RESPONSE",
					status: "404",
					cookies: event.data.cookies,
					url: event.data.url,
					type: "text/plain",
					body: "Not found"
				},"*");
			}
			break;
	}
},false);

// Helper to remove string prefixes
function removePrefix(string,prefix) {
	if(string.indexOf(prefix) === 0) {
		return string.substr(prefix.length);
	} else {
		return string;
	}
}

// Helper for HTTP GET
function httpGet(url,callback) {
	var http = new XMLHttpRequest();
	http.open("GET",url,true);
	http.onreadystatechange = function() {
		if(http.readyState == 4 && http.status == 200) {
			callback(null,http.responseText);
		}
	};
	http.send();
}

})();

</script>
</head>
<body><h1>HelloThere</h1><p>This is the TiddlyWiki plugin library. It is not intended to be opened directly in the browser.</p><p>See <a href="https://tiddlywiki.com/" target="_blank">https://tiddlywiki.com/</a> for details of how to install plugins.</p></body>
</html>